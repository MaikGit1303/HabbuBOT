<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Habbus</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <%
        // Verificaciones para variables indefinidas
        if (!stats) stats = { status: 'Offline', servers: 0, ping: 0 };
        if (!config) config = {
            prefix: '!', language: 'es', timezone: 'America/Bogota',
            ignoredChannels: [], adminRole: [], modRole: [], muteRole: '',
            automodBadWords: false, automodLinks: false,
            logChannel: '', logMessages: false, logMembers: false,
            botNickname: 'Habbus', botAvatar: '', embedColor: '#ff0f0f',
            botStatus: 'online', activityType: 0, activityText: 'Navidad',
            welcomeEnabled: false, welcomeChannel: '', welcomeMessage: 'Â¡Bienvenido {user} a {server}!'
        };
        if (!user) user = { username: 'Usuario', id: '0', avatar: '0' };
        if (!servers) servers = [];
        if (!channels) channels = [];
        if (!roles) roles = [];
        if (!selectedGuildId) selectedGuildId = '';
    %>

    <%
        if (typeof servers !== 'undefined' && servers.length > 0) {
            if (typeof selectedGuildId !== 'undefined' && selectedGuildId) {
                const found = servers.find(s => s.id === selectedGuildId);
                if (found) currentServer = { name: found.name, icon: found.icon ? `https://cdn.discordapp.com/icons/${found.id}/${found.icon}.png` : `https://cdn.discordapp.com/embed/avatars/0.png`, id: found.id };
            } 
            if (!currentServer.id && servers.length > 0) {
                const first = servers[0];
                currentServer = { name: first.name, icon: first.icon ? `https://cdn.discordapp.com/icons/${first.id}/${first.icon}.png` : `https://cdn.discordapp.com/embed/avatars/0.png`, id: first.id };
            }
        }
    %>

    <div class="snow-container"></div>

    <nav class="top-nav">
        <div class="nav-left">
            <button id="sidebarToggle" class="toggle-btn"><i class="fa-solid fa-bars"></i></button>
            <a href="/" class="brand"><img src="/images/logo_navidad.png" alt="Habbus"></a>
            <div class="status-console"><span class="status-dot"></span><span class="console-text">SYSTEM: <span style="color: #43b581;">ONLINE</span></span></div>
        </div>
        <div class="nav-right">
            <a href="/invite" target="_blank" class="nav-invite-btn"><i class="fa-solid fa-plus"></i> Invitar</a>
            <div class="server-dropdown-container">
                <div class="server-selector" onclick="toggleServerMenu()">
                    <img id="currentServerIcon" src="<%= currentServer.icon %>" class="server-icon-small">
                    <span id="currentServerName"><%= currentServer.name %></span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
                <div id="serverMenu" class="server-list-dropdown">
                    <% if (typeof servers !== 'undefined' && servers.length > 0) { %>
                        <% servers.forEach((guild) => { %>
                            <div class="server-option" onclick="selectServer('<%= guild.id %>')">
                                <img src="<%= guild.icon ? `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png` : `https://cdn.discordapp.com/embed/avatars/0.png` %>">
                                <span><%= guild.name %></span>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <div class="server-option"><span>No administras servidores</span></div>
                    <% } %>
                </div>
            </div>
            <a href="#" class="nav-premium-btn"><i class="fa-solid fa-crown"></i> Premium</a>
            <div class="user-dropdown">
                <div class="user-info-text"><span class="username"><%= user.username %></span><span class="user-role">Admin</span></div>
                <img src="https://cdn.discordapp.com/avatars/<%= user.id %>/<%= user.avatar %>.png" alt="Avatar">
                <a href="/logout" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i></a>
            </div>
        </div>
    </nav>

    <div class="layout-wrapper">
        
        <aside class="sidebar" id="sidebar">
            <div class="menu-section">
                <div class="menu-item active" onclick="openTab(event, 'panel')"><i class="fa-solid fa-border-all"></i> <span class="link-text">Panel de control</span></div>
                <div class="menu-item" onclick="openTab(event, 'personalizador')"><i class="fa-solid fa-wand-magic-sparkles"></i> <span class="link-text">Personalizador</span></div>
                <div class="menu-item" onclick="openTab(event, 'ajustes')"><i class="fa-solid fa-gear"></i> <span class="link-text">Ajustes</span></div>
                <div class="menu-item" onclick="openTab(event, 'premium')"><i class="fa-solid fa-crown" style="color: var(--gold);"></i> <span class="link-text">Premium</span></div>
                <div class="menu-item" onclick="openTab(event, 'emojis')"><i class="fa-solid fa-icons"></i> <span class="link-text">Emojis</span></div>
            </div>
            <div class="menu-section">
                <span class="menu-header">GESTIÃ“N DEL SERVIDOR</span>
                <div class="menu-item" onclick="openTab(event, 'bienvenida')"><i class="fa-solid fa-hand-spock"></i> <span class="link-text">Bienvenidas</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-door-open"></i> <span class="link-text">Canal Bienvenida</span></div>
                <div class="menu-item" onclick="openTab(event, 'moderacion')"><i class="fa-solid fa-gavel"></i> <span class="link-text">ModeraciÃ³n</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-medal"></i> <span class="link-text">Logros</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-user-check"></i> <span class="link-text">VerificaciÃ³n</span></div>
                <div class="menu-item" onclick="openTab(event, 'registros')"><i class="fa-solid fa-file-lines"></i> <span class="link-text">Registros</span></div>
            </div>
            <div class="menu-section">
                <span class="menu-header">UTILIDADES</span>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-id-card"></i> <span class="link-text">Roles ReacciÃ³n</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-pen-to-square"></i> <span class="link-text">Embeds</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-rss"></i> <span class="link-text">Alertas Sociales</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-robot"></i> <span class="link-text">Automatizaciones</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-terminal"></i> <span class="link-text">Comandos</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-user-plus"></i> <span class="link-text">Rastreador</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-ticket"></i> <span class="link-text">Tickets</span></div>
            </div>
            <div class="menu-section">
                <span class="menu-header">DIVERSIÃ“N Y COMUNIDAD</span>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-bell"></i> <span class="link-text">Recordatorios</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-cake-candles"></i> <span class="link-text">CumpleaÃ±os</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-gift"></i> <span class="link-text">Sorteos</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-trophy"></i> <span class="link-text">Niveles y XP</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-music"></i> <span class="link-text">MÃºsica</span></div>
            </div>
            <div class="menu-section">
                <span class="menu-header">EXTRAS</span>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-coins"></i> <span class="link-text">EconomÃ­a</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-chart-simple"></i> <span class="link-text">EstadÃ­sticas</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-magnifying-glass"></i> <span class="link-text">Buscador</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-circle-question"></i> <span class="link-text">Ayuda</span></div>
            </div>
            <div class="menu-footer">
                <a href="/" class="menu-item back-item"><i class="fa-solid fa-arrow-left"></i> <span class="link-text">Volver al Inicio</span></a>
            </div>
        </aside>

        <main class="content-area">
            <form id="configForm" action="/save-config" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="guildId" id="guildIdInput" value="<%= currentServer.id %>">

                <div id="panel" class="tab-content active" style="display: block; opacity: 1;">
                    <div class="content-header">
                        <h1>Panel de Control</h1>
                        <p>Gestiona los mÃ³dulos de <strong><%= currentServer.name %></strong></p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card"><i class="fa-solid fa-signal" style="color: #43b581;"></i><div><h3><%= stats.status %></h3><span>Estado</span></div></div>
                        <div class="stat-card"><i class="fa-solid fa-server" style="color: #5865F2;"></i><div><h3><%= stats.servers %></h3><span>Servidores</span></div></div>
                        <div class="stat-card"><i class="fa-solid fa-bolt" style="color: #ffc107;"></i><div><h3><%= stats.ping %>ms</h3><span>Latencia</span></div></div>
                    </div>

                    <hr class="divider">

                    <h3 class="section-title"><i class="fa-solid fa-server"></i> GestiÃ³n del Servidor</h3>
                    <div class="modules-grid">
                        <div class="module-card"><div class="module-header"><div class="module-icon blue-icon"><i class="fa-solid fa-hand-spock"></i></div></div><h4>Bienvenidas</h4><p>Configura mensajes de entrada.</p><button type="button" class="btn-module" onclick="openTab(null, 'bienvenida')">Configurar</button></div>
                        <div class="module-card"><div class="module-header"><div class="module-icon cyan-icon"><i class="fa-solid fa-door-open"></i></div></div><h4>Canal Bienvenida</h4><p>Define dÃ³nde saluda el bot.</p><button type="button" class="btn-module" onclick="openTab(null, 'construccion')">Configurar</button></div>
                        <div class="module-card"><div class="module-header"><div class="module-icon red-icon"><i class="fa-solid fa-gavel"></i></div></div><h4>ModeraciÃ³n</h4><p>Ban, kick, mute y automod.</p><button type="button" class="btn-module" onclick="openTab(null, 'moderacion')">Configurar</button></div>
                        <div class="module-card"><div class="module-header"><div class="module-icon yellow-icon"><i class="fa-solid fa-medal"></i></div></div><h4>Logros</h4><p>Medallas para usuarios.</p><button type="button" class="btn-module" onclick="openTab(null, 'construccion')">+ Habilitar</button></div>
                        <div class="module-card"><div class="module-header"><div class="module-icon green-icon"><i class="fa-solid fa-user-check"></i></div></div><h4>VerificaciÃ³n</h4><p>Sistema de captcha.</p><button type="button" class="btn-module" onclick="openTab(null, 'construccion')">+ Habilitar</button></div>
                        <div class="module-card"><div class="module-header"><div class="module-icon purple-icon"><i class="fa-solid fa-file-lines"></i></div></div><h4>Registros</h4><p>Logs de auditorÃ­a.</p><button type="button" class="btn-module" onclick="openTab(null, 'registros')">+ Habilitar</button></div>
                    </div>

                    <h3 class="section-title"><i class="fa-solid fa-toolbox"></i> Utilidades</h3>
                    <div class="modules-grid">
                        <div class="module-card"><div class="module-header"><div class="module-icon yellow-icon"><i class="fa-solid fa-id-card"></i></div></div><h4>Roles ReacciÃ³n</h4><p>Roles por clic en emoji.</p><button type="button" class="btn-module" onclick="openTab(null, 'construccion')">Configurar</button></div>
                        <div class="module-card"><div class="module-header"><div class="module-icon cyan-icon"><i class="fa-solid fa-pen-to-square"></i></div></div><h4>Embeds</h4><p>Mensajes visuales avanzados.</p><button type="button" class="btn-module" onclick="openTab(null, 'construccion')">Crear</button></div>
                    </div>
                </div>

                <div id="personalizador" class="tab-content" style="display: none;">
                    <div class="content-header"><h1>Personalizador</h1><p>Define la identidad y presencia del bot.</p></div>
                    <div class="settings-card">
                        <div class="setting-row" style="align-items: flex-start;">
                            <div class="setting-info" style="flex: 1;">
                                <div style="margin-bottom: 20px;"><label>Apodo en este Servidor</label><input type="text" name="botNickname" value="<%= config.botNickname || 'Habbus' %>" class="form-input change-detect" placeholder="Ej: Santa Claus"></div>
                                <div style="margin-bottom: 20px;"><label>Avatar del Servidor</label><span class="desc">Sube una imagen (PNG o JPG, mÃ¡x 8MB).</span><input type="file" id="botAvatarInput" name="botAvatarFile" accept="image/*" class="form-input change-detect" style="padding: 8px;"></div>
                                <div style="margin-bottom: 20px;"><label>Estado del Bot</label><select name="botStatus" id="statusSelect" class="form-input change-detect"><option value="online" <%= config.botStatus === 'online' ? 'selected' : '' %>>ðŸŸ¢ En LÃ­nea</option><option value="idle" <%= config.botStatus === 'idle' ? 'selected' : '' %>>ðŸŒ™ Ausente</option><option value="dnd" <%= config.botStatus === 'dnd' ? 'selected' : '' %>>â›” No Molestar</option><option value="invisible" <%= config.botStatus === 'invisible' ? 'selected' : '' %>>ðŸ‘» Invisible</option></select></div>
                                <div style="display: flex; gap: 10px;"><div style="flex: 1;"><label>Tipo</label><select name="activityType" id="activityTypeSelect" class="form-input change-detect"><option value="0" <%= config.activityType === 0 ? 'selected' : '' %>>Jugando a</option><option value="3" <%= config.activityType === 3 ? 'selected' : '' %>>Viendo</option><option value="2" <%= config.activityType === 2 ? 'selected' : '' %>>Escuchando</option><option value="5" <%= config.activityType === 5 ? 'selected' : '' %>>Compitiendo en</option></select></div><div style="flex: 2;"><label>Texto</label><input type="text" name="activityText" id="activityTextInput" value="<%= config.activityText || 'Navidad' %>" class="form-input change-detect"></div></div>
                            </div>
                            <div class="setting-input" style="flex: 0 0 320px; margin-left: 40px;">
                                <label style="margin-bottom: 10px; display: block;">Vista Previa</label>
                                <div class="discord-preview-card">
                                    <div class="discord-user">
                                        <div class="avatar-wrapper"><img src="<%= config.botAvatar || '/images/logo_navidad.png' %>" alt="Bot" class="bot-avatar-preview" id="previewAvatarImg"><div class="status-indicator" id="previewStatusDot"></div></div>
                                        <div style="display: flex; flex-direction: column;"><div style="display: flex; align-items: center; gap: 5px;"><span class="bot-name-preview"><%= config.botNickname || 'Habbus' %></span><span class="bot-tag">BOT</span></div><span class="activity-preview" id="previewActivity" style="font-size: 0.75rem; color: #b9bbbe;">Jugando a <strong>Navidad</strong></span></div>
                                    </div>
                                    <div class="discord-embed" id="embedPreview" style="border-left-color: <%= config.embedColor || '#ff0f0f' %>; margin-top: 10px;"><div class="embed-title">Mensaje de Ejemplo</div><div class="embed-desc">Â¡Hola! AsÃ­ se ve mi perfil y mis colores en tu servidor.</div></div>
                                </div>
                                <div style="margin-top: 20px;"><label>Color del Tema</label><div style="margin-top: 5px; display: flex; align-items: center; gap: 10px;"><input type="color" id="colorPicker" name="embedColor" value="<%= config.embedColor || '#ff0f0f' %>" class="change-detect" style="height: 40px; width: 100%; cursor: pointer; border: none; background: none;"></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="ajustes" class="tab-content" style="display: none;">
                    <div class="content-header"><h1>Ajustes Generales</h1><p>ConfiguraciÃ³n esencial del nÃºcleo del bot.</p></div>
                    <div class="settings-card">
                        
                        <div class="setting-row">
                            <div class="setting-info"><label>Prefijo</label></div>
                            <div class="setting-input"><input type="text" name="prefix" value="<%= config.prefix %>" class="form-input change-detect" style="width: 100px;"></div>
                        </div>
                        
                        <div class="setting-row">
                            <div class="setting-info"><label>Idioma</label></div>
                            <div class="setting-input"><select name="language" class="form-input change-detect"><option value="es" <%= config.language === 'es' ? 'selected' : '' %>>ðŸ‡ªðŸ‡¸ EspaÃ±ol</option><option value="en" <%= config.language === 'en' ? 'selected' : '' %>>ðŸ‡ºðŸ‡¸ English</option></select></div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info"><label>Zona Horaria</label></div>
                            <div class="setting-input"><select name="timezone" class="form-input change-detect"><option value="America/Bogota" <%= config.timezone === 'America/Bogota' ? 'selected' : '' %>>ðŸ‡¨ðŸ‡´ Colombia</option><option value="America/Mexico_City" <%= config.timezone === 'America/Mexico_City' ? 'selected' : '' %>>ðŸ‡²ðŸ‡½ MÃ©xico</option><option value="Europe/Madrid" <%= config.timezone === 'Europe/Madrid' ? 'selected' : '' %>>ðŸ‡ªðŸ‡¸ EspaÃ±a</option><option value="America/New_York" <%= config.timezone === 'America/New_York' ? 'selected' : '' %>>ðŸ‡ºðŸ‡¸ USA Este</option></select></div>
                        </div>

                        <hr class="divider">

                        <div class="setting-row">
                            <div class="setting-info"><label>Canales Ignorados</label><span class="desc">No responder aquÃ­.</span></div>
                            <div class="setting-input">
                                <div class="multiselect-container" id="dd-ignored">
                                    <div class="select-box" onclick="toggleMultiSelect('dd-ignored')"><span class="selected-text">Seleccionar canales...</span><i class="fa-solid fa-chevron-down"></i></div>
                                    <div class="options-container">
                                        <% if(channels){ channels.forEach(c => { let isChecked = config.ignoredChannels && (Array.isArray(config.ignoredChannels) ? config.ignoredChannels.includes(c.id) : config.ignoredChannels == c.id); %>
                                            <label class="option-item"><input type="checkbox" name="ignoredChannels" value="<%= c.id %>" <%= isChecked ? 'checked' : '' %> onchange="updateSelectText('dd-ignored')"><span># <%= c.name %></span></label>
                                        <% }) } %>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="divider">
                        <h3>JerarquÃ­a y Permisos</h3>

                        <div class="setting-row">
                            <div class="setting-info"><label>Roles Admin</label><span class="desc">Acceso total.</span></div>
                            <div class="setting-input">
                                <div class="multiselect-container" id="dd-admin">
                                    <div class="select-box" onclick="toggleMultiSelect('dd-admin')"><span class="selected-text">Seleccionar roles...</span><i class="fa-solid fa-chevron-down"></i></div>
                                    <div class="options-container">
                                        <% if(roles){ roles.forEach(r => { let isChecked = config.adminRole && (Array.isArray(config.adminRole) ? config.adminRole.includes(r.id) : config.adminRole == r.id); let textColor = r.color === '#000000' ? '#ddd' : r.color; %>
                                            <label class="option-item"><input type="checkbox" name="adminRole" value="<%= r.id %>" <%= isChecked ? 'checked' : '' %> onchange="updateSelectText('dd-admin')"><span class="role-dot-small" style="background-color: <%= r.color %>;"></span><span style="color: <%= textColor %>"><%= r.name %></span></label>
                                        <% }) } else { %><div style="color: #888; padding: 10px;">Sin roles.</div><% } %>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info"><label>Roles Moderador</label><span class="desc">Ban, Kick, Mute.</span></div>
                            <div class="setting-input">
                                <div class="multiselect-container" id="dd-mod">
                                    <div class="select-box" onclick="toggleMultiSelect('dd-mod')"><span class="selected-text">Seleccionar roles...</span><i class="fa-solid fa-chevron-down"></i></div>
                                    <div class="options-container">
                                        <% if(roles){ roles.forEach(r => { let isChecked = config.modRole && (Array.isArray(config.modRole) ? config.modRole.includes(r.id) : config.modRole == r.id); let textColor = r.color === '#000000' ? '#ddd' : r.color; %>
                                            <label class="option-item"><input type="checkbox" name="modRole" value="<%= r.id %>" <%= isChecked ? 'checked' : '' %> onchange="updateSelectText('dd-mod')"><span class="role-dot-small" style="background-color: <%= r.color %>;"></span><span style="color: <%= textColor %>"><%= r.name %></span></label>
                                        <% }) } %>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info"><label>Rol Silenciado</label></div>
                            <div class="setting-input">
                                <select name="muteRole" class="form-input change-detect">
                                    <option value="">-- Ãšnico --</option>
                                    <% if(typeof roles !== 'undefined' && roles.length > 0){ roles.forEach(r=>{ %><option value="<%= r.id %>" <%= config.muteRole===r.id?'selected':'' %> style="color:<%= r.color %>">@<%= r.name %></option><% }) } %>
                                </select>
                            </div>
                        </div>

                    </div>
                </div>

                <div id="bienvenida" class="tab-content" style="display: none;">
                    <div class="content-header"><h1>Sistema de Bienvenida</h1></div>
                    <div class="settings-card">
                        <div class="setting-row" style="align-items: center; justify-content: space-between;"><div class="setting-info"><label>Habilitar</label></div><label class="switch"><input type="checkbox" name="welcomeEnabled" class="change-detect" <%= config.welcomeEnabled ? 'checked' : '' %>><span class="slider round"></span></label></div>
                        <hr class="divider">
                        <div class="setting-row"><div class="setting-info"><label>Canal</label></div><div class="setting-input"><select name="welcomeChannel" class="form-input change-detect"><option value="" disabled <%= !config.welcomeChannel ? 'selected' : '' %>>Selecciona...</option><% if (typeof channels !== 'undefined' && channels.length > 0) { %><% channels.forEach(ch => { %><option value="<%= ch.id %>" <%= config.welcomeChannel === ch.id ? 'selected' : '' %>># <%= ch.name %></option><% }) %><% } else { %><option value="" disabled>Sin canales</option><% } %></select></div></div>
                        <div class="setting-row"><div class="setting-info"><label>Mensaje</label></div><div class="setting-input"><textarea name="welcomeMessage" rows="5" class="form-input change-detect"><%= config.welcomeMessage %></textarea></div></div>
                    </div>
                </div>

                <div id="moderacion" class="tab-content" style="display: none;">
                    <div class="content-header"><h1>ModeraciÃ³n</h1></div>
                    <div class="settings-card">
                        <div class="setting-row" style="align-items: center; justify-content: space-between;"><div class="setting-info"><label style="color:#ff5555;">Anti-Malas Palabras</label></div><label class="switch"><input type="checkbox" name="automodBadWords" class="change-detect" <%= config.automodBadWords ? 'checked' : '' %>><span class="slider round"></span></label></div>
                        <hr class="divider">
                        <div class="setting-row" style="align-items: center; justify-content: space-between;"><div class="setting-info"><label style="color:#5865F2;">Anti-Links</label></div><label class="switch"><input type="checkbox" name="automodLinks" class="change-detect" <%= config.automodLinks ? 'checked' : '' %>><span class="slider round"></span></label></div>
                    </div>
                </div>

                <div id="registros" class="tab-content" style="display: none;">
                    <div class="content-header"><h1>Registros</h1></div>
                    <div class="settings-card">
                        <div class="setting-row"><div class="setting-info"><label>Canal Logs</label></div><div class="setting-input"><select name="logChannel" class="form-input change-detect"><option value="" disabled <%= !config.logChannel ? 'selected' : '' %>>Selecciona...</option><% if(typeof channels!=='undefined'){ channels.forEach(c=>{ %><option value="<%= c.id %>" <%= config.logChannel===c.id?'selected':'' %>># <%= c.name %></option><% }) } %></select></div></div>
                        <hr class="divider">
                        <div class="setting-row" style="align-items: center; justify-content: space-between;"><div class="setting-info"><label>Mensajes Borrados</label></div><label class="switch"><input type="checkbox" name="logMessages" class="change-detect" <%= config.logMessages ? 'checked' : '' %>><span class="slider round"></span></label></div>
                        <div class="setting-row" style="align-items: center; justify-content: space-between; margin-top:15px;"><div class="setting-info"><label>Entradas/Salidas</label></div><label class="switch"><input type="checkbox" name="logMembers" class="change-detect" <%= config.logMembers ? 'checked' : '' %>><span class="slider round"></span></label></div>
                    </div>
                </div>

                <div id="construccion" class="tab-content" style="display: none; text-align: center; padding-top: 50px;"><i class="fa-solid fa-person-digging" style="font-size: 4rem; color: rgba(255,255,255,0.2); margin-bottom: 20px;"></i><h2>PrÃ³ximamente</h2></div>
                <div id="premium" class="tab-content" style="display: none; text-align: center; padding-top: 50px;"><h2>ðŸ’Ž Premium</h2></div>
                <div id="emojis" class="tab-content" style="display: none; text-align: center; padding-top: 50px;"><h2>ðŸ˜€ Emojis</h2></div>

                <div id="saveBar" class="floating-save-bar"><span>Â¡Tienes cambios sin guardar!</span><button type="submit" class="btn-save">Guardar Cambios</button></div>
            </form>
        </main>
    </div>

    <div id="successToast" class="success-toast"><i class="fa-solid fa-check-circle"></i> Guardado correctamente</div>

    <script>
        // TABS
        function openTab(evt, tabName) { 
            document.querySelectorAll('.tab-content').forEach(d => {
                d.style.display='none'; 
                d.style.opacity='0';
            });
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            
            const sel = document.getElementById(tabName);
            if(sel) { 
                sel.style.display='block'; 
                setTimeout(()=>sel.style.opacity='1', 10); 
            }
            if(evt) evt.currentTarget.classList.add('active');
        }

        document.getElementById('sidebarToggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('collapsed'));
        
        const serverMenu = document.getElementById('serverMenu');
        function toggleServerMenu() { serverMenu.classList.toggle('show'); }
        function selectServer(id) { window.location.href = '/dashboard?guild=' + id; }
        window.onclick = e => { if(!e.target.closest('.server-dropdown-container')) serverMenu.classList.remove('show'); };
        
        // --- DETECCIÃ“N DE CAMBIOS (CORREGIDA) ---
        const form = document.getElementById('configForm');
        const saveBar = document.getElementById('saveBar');
        const inputs = document.querySelectorAll('.change-detect');
        
        // Solo mostramos la barra cuando el USUARIO toca algo
        form.addEventListener('change', () => saveBar.classList.add('show'));
        form.addEventListener('input', () => saveBar.classList.add('show'));

        // --- LÃ“GICA DROPDOWNS MULTI-SELECT ---
        function toggleMultiSelect(id) {
            const container = document.getElementById(id);
            const box = container.querySelector('.select-box');
            const opts = container.querySelector('.options-container');
            
            // Cerrar otros
            document.querySelectorAll('.options-container').forEach(el => {
                if(el !== opts) el.classList.remove('show');
            });
            document.querySelectorAll('.select-box').forEach(el => {
                if(el !== box) el.classList.remove('active');
            });

            opts.classList.toggle('show');
            box.classList.toggle('active');
        }

        // Actualizar texto "X seleccionados" (SIN ACTIVAR LA BARRA DE GUARDADO)
        function updateSelectText(id) {
            const container = document.getElementById(id);
            if(!container) return;
            const checked = container.querySelectorAll('input[type="checkbox"]:checked');
            const textSpan = container.querySelector('.selected-text');
            
            if (checked.length === 0) {
                textSpan.textContent = "Seleccionar...";
                textSpan.style.color = "#888";
            } else {
                textSpan.textContent = `${checked.length} seleccionado(s)`;
                textSpan.style.color = "#fff";
            }
            // *** ELIMINÃ‰ LA LÃNEA QUE ACTIVABA LA BARRA AQUÃ ***
            // La barra ahora se activa sola gracias al evento 'change' del formulario
        }

        // Cerrar al hacer clic fuera
        window.onclick = function(event) {
            if (!event.target.closest('.multiselect-container')) {
                document.querySelectorAll('.options-container').forEach(el => el.classList.remove('show'));
                document.querySelectorAll('.select-box').forEach(el => el.classList.remove('active'));
            }
            if(!event.target.closest('.server-dropdown-container')) document.getElementById('serverMenu').classList.remove('show');
        }

        // --- LÃ“GICA DE PERSONALIZADOR ---
        const colorPicker = document.getElementById('colorPicker');
        const embedPreview = document.getElementById('embedPreview');
        const botNicknameInput = document.querySelector('input[name="botNickname"]');
        const botNamePreview = document.querySelector('.bot-name-preview');
        const botAvatarInput = document.getElementById('botAvatarInput');
        const previewAvatarImg = document.getElementById('previewAvatarImg');
        const statusSelect = document.getElementById('statusSelect');
        const previewStatusDot = document.getElementById('previewStatusDot');
        const activityTypeSelect = document.getElementById('activityTypeSelect');
        const activityTextInput = document.getElementById('activityTextInput');
        const previewActivity = document.getElementById('previewActivity');

        if(colorPicker) colorPicker.addEventListener('input', (e) => embedPreview.style.borderLeftColor = e.target.value);
        if(botNicknameInput) botNicknameInput.addEventListener('input', (e) => botNamePreview.textContent = e.target.value || "Habbus");
        if(botAvatarInput) botAvatarInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = function(e) { previewAvatarImg.src = e.target.result; }; reader.readAsDataURL(file); } });
        
        function updateStatusPreview() { 
            const typeMap = { "0": "Jugando a", "2": "Escuchando", "3": "Viendo", "5": "Compitiendo en" };
            const typeText = typeMap[activityTypeSelect.value] || "";
            const text = activityTextInput.value;
            previewActivity.innerHTML = `${typeText} <strong>${text}</strong>`;
            const statusColors = { "online": "#43b581", "idle": "#faa61a", "dnd": "#f04747", "invisible": "#747f8d" };
            previewStatusDot.style.backgroundColor = statusColors[statusSelect.value] || "#43b581";
        }
        if(statusSelect && activityTypeSelect && activityTextInput) { 
            statusSelect.addEventListener('change', updateStatusPreview); 
            activityTypeSelect.addEventListener('change', updateStatusPreview); 
            activityTextInput.addEventListener('input', updateStatusPreview); 
            updateStatusPreview(); 
        }

        // --- ENVIAR FORMULARIO ---
        form.addEventListener('submit', e => {
            e.preventDefault();
            const formData = new FormData(form);
            fetch('/save-config', { method: 'POST', body: formData }).then(r => {
                if(r.ok){ 
                    saveBar.classList.remove('show'); 
                    const t=document.getElementById('successToast'); t.classList.add('active'); setTimeout(()=>t.classList.remove('active'),3000); 
                } else { alert("Error al guardar."); }
            }).catch(err => { console.error(err); alert("Error de red."); });
        });

        // --- INICIALIZAR TEXTOS Y VISIBILIDAD ---
        window.onload = function() { 
            const p = document.getElementById('panel'); 
            if(p) { p.style.display='block'; setTimeout(()=>p.style.opacity='1', 10); }
            Ã±
            // Calculamos los textos iniciales sin activar la barra
            updateSelectText('dd-ignored'); 
            updateSelectText('dd-admin'); 
            updateSelectText('dd-mod');
        };
    </script>
</body>
</html>