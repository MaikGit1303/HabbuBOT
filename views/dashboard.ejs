<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Habbus</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <% 
        let currentServer = { name: "Sin servidores", icon: "https://cdn.discordapp.com/embed/avatars/0.png", id: "" };
        
        // Si hay servidores en la lista
        if (typeof servers !== 'undefined' && servers.length > 0) {
            // 1. Intentamos buscar el servidor seleccionado por ID
            if (typeof selectedGuildId !== 'undefined' && selectedGuildId) {
                const found = servers.find(s => s.id === selectedGuildId);
                if (found) {
                    currentServer = { 
                        name: found.name, 
                        icon: found.icon ? `https://cdn.discordapp.com/icons/${found.id}/${found.icon}.png` : `https://cdn.discordapp.com/embed/avatars/0.png`,
                        id: found.id
                    };
                }
            } 
            
            // 2. Si no encontramos ninguno (o es la primera vez), usamos el PRIMERO de la lista
            if (!currentServer.id && servers.length > 0) {
                const first = servers[0];
                currentServer = { 
                    name: first.name, 
                    icon: first.icon ? `https://cdn.discordapp.com/icons/${first.id}/${first.icon}.png` : `https://cdn.discordapp.com/embed/avatars/0.png`,
                    id: first.id
                };
            }
        }
    %>

    <div class="snow-container"></div>

    <nav class="top-nav">
        <div class="nav-left">
            <button id="sidebarToggle" class="toggle-btn"><i class="fa-solid fa-bars"></i></button>
            <a href="/" class="brand"><img src="/images/logo_navidad.png" alt="Habbus"></a>
            <div class="status-console">
                <span class="status-dot"></span><span class="console-text">SYSTEM: <span style="color: #43b581;">ONLINE</span></span>
            </div>
        </div>
        
        <div class="nav-right">
            <a href="/invite" target="_blank" class="nav-invite-btn"><i class="fa-solid fa-plus"></i> Invitar</a>
            
            <div class="server-dropdown-container">
                <div class="server-selector" onclick="toggleServerMenu()">
                    <img id="currentServerIcon" src="<%= currentServer.icon %>" class="server-icon-small">
                    <span id="currentServerName"><%= currentServer.name %></span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
                
                <div id="serverMenu" class="server-list-dropdown">
                    <% if (typeof servers !== 'undefined' && servers.length > 0) { %>
                        <% servers.forEach((guild) => { %>
                            <div class="server-option" 
                                 onclick="selectServer('<%= guild.id %>')">
                                <img src="<%= guild.icon ? `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png` : `https://cdn.discordapp.com/embed/avatars/0.png` %>">
                                <span><%= guild.name %></span>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <div class="server-option"><span>No administras servidores</span></div>
                    <% } %>
                </div>
            </div>

            <a href="#" class="nav-premium-btn"><i class="fa-solid fa-crown"></i> Premium</a>
            <div class="user-dropdown">
                <div class="user-info-text"><span class="username"><%= user.username %></span><span class="user-role">Admin</span></div>
                <img src="https://cdn.discordapp.com/avatars/<%= user.id %>/<%= user.avatar %>.png" alt="Avatar">
                <a href="/logout" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i></a>
            </div>
        </div>
    </nav>

    <div class="layout-wrapper">
        
        <aside class="sidebar" id="sidebar">
            <div class="menu-section">
                <div class="menu-item active" onclick="openTab(event, 'panel')"><i class="fa-solid fa-border-all"></i> <span class="link-text">Panel de control</span></div>
                <div class="menu-item" onclick="openTab(event, 'personalizador')"><i class="fa-solid fa-wand-magic-sparkles"></i> <span class="link-text">Personalizador</span></div>
                <div class="menu-item" onclick="openTab(event, 'ajustes')"><i class="fa-solid fa-gear"></i> <span class="link-text">Ajustes</span></div>
                <div class="menu-item" onclick="openTab(event, 'premium')"><i class="fa-solid fa-crown" style="color: var(--gold);"></i> <span class="link-text">Premium</span></div>
                <div class="menu-item" onclick="openTab(event, 'emojis')"><i class="fa-solid fa-icons"></i> <span class="link-text">Emojis</span></div>
            </div>

            <div class="menu-section">
                <span class="menu-header">GESTI칍N DEL SERVIDOR</span>
                <div class="menu-item" onclick="openTab(event, 'bienvenida')"><i class="fa-solid fa-hand-spock"></i> <span class="link-text">Bienvenidas</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-door-open"></i> <span class="link-text">Canal Bienvenida</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-gavel"></i> <span class="link-text">Moderaci칩n</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-medal"></i> <span class="link-text">Logros</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-user-check"></i> <span class="link-text">Verificaci칩n</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-file-lines"></i> <span class="link-text">Registros</span></div>
            </div>

            <div class="menu-section">
                <span class="menu-header">UTILIDADES</span>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-id-card"></i> <span class="link-text">Roles Reacci칩n</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-pen-to-square"></i> <span class="link-text">Embeds</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-rss"></i> <span class="link-text">Alertas Sociales</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-robot"></i> <span class="link-text">Automatizaciones</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-terminal"></i> <span class="link-text">Comandos</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-user-plus"></i> <span class="link-text">Rastreador</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-ticket"></i> <span class="link-text">Tickets</span></div>
            </div>

            <div class="menu-section">
                <span class="menu-header">DIVERSI칍N Y COMUNIDAD</span>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-bell"></i> <span class="link-text">Recordatorios</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-cake-candles"></i> <span class="link-text">Cumplea침os</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-gift"></i> <span class="link-text">Sorteos</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-trophy"></i> <span class="link-text">Niveles y XP</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-music"></i> <span class="link-text">M칰sica</span></div>
            </div>

            <div class="menu-section">
                <span class="menu-header">EXTRAS</span>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-coins"></i> <span class="link-text">Econom칤a</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-chart-simple"></i> <span class="link-text">Estad칤sticas</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-magnifying-glass"></i> <span class="link-text">Buscador</span></div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-circle-question"></i> <span class="link-text">Ayuda</span></div>
            </div>
            
            <div class="menu-footer">
                <a href="/" class="menu-item back-item"><i class="fa-solid fa-arrow-left"></i> <span class="link-text">Volver al Inicio</span></a>
            </div>
        </aside>

        <main class="content-area">
            <form id="configForm" action="/save-config" method="POST">
                <input type="hidden" name="guildId" id="guildIdInput" value="<%= currentServer.id %>">

                <div id="panel" class="tab-content active">
                    <div class="content-header">
                        <h1>Panel de Control</h1>
                        <p>Est치s gestionando: <strong><%= currentServer.name %></strong></p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card"><i class="fa-solid fa-signal" style="color: #43b581;"></i><div><h3><%= stats.status %></h3><span>Estado</span></div></div>
                        <div class="stat-card"><i class="fa-solid fa-server" style="color: #5865F2;"></i><div><h3><%= stats.servers %></h3><span>Servidores</span></div></div>
                        <div class="stat-card"><i class="fa-solid fa-bolt" style="color: #ffc107;"></i><div><h3><%= stats.ping %>ms</h3><span>Latencia</span></div></div>
                    </div>

                    <hr class="divider">

                    <h3 class="section-title"><i class="fa-solid fa-server"></i> Gesti칩n del Servidor</h3>
                    <div class="modules-grid">
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon blue-icon"><i class="fa-solid fa-hand-spock"></i></div></div>
                            <h4>Bienvenidas</h4><p>Configura mensajes de entrada y salida.</p>
                            <button type="button" class="btn-module" onclick="openTab(null, 'bienvenida')">Configurar</button>
                        </div>
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon red-icon"><i class="fa-solid fa-gavel"></i></div></div>
                            <h4>Moderaci칩n</h4><p>Sistema de ban, kick y mute.</p>
                            <button type="button" class="btn-module">Configurar</button>
                        </div>
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon purple-icon"><i class="fa-solid fa-file-lines"></i></div></div>
                            <h4>Registros</h4><p>Historial de cambios y auditor칤a.</p>
                            <button type="button" class="btn-module">+ Habilitar</button>
                        </div>
                    </div>

                    <h3 class="section-title"><i class="fa-solid fa-toolbox"></i> Utilidades</h3>
                    <div class="modules-grid">
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon yellow-icon"><i class="fa-solid fa-id-card"></i></div></div>
                            <h4>Roles Reacci칩n</h4><p>Roles por clic en emoji.</p>
                            <button type="button" class="btn-module" onclick="openTab(null, 'construccion')">Configurar</button>
                        </div>
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon cyan-icon"><i class="fa-solid fa-pen-to-square"></i></div></div>
                            <h4>Embeds</h4><p>Mensajes visuales avanzados.</p>
                            <button type="button" class="btn-module" onclick="openTab(null, 'construccion')">Crear</button>
                        </div>
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon red-icon"><i class="fa-solid fa-rss"></i></div></div>
                            <h4>Alertas Sociales</h4><p>Notificaciones de YouTube/Twitch.</p>
                            <button type="button" class="btn-module" onclick="openTab(null, 'construccion')">+ Habilitar</button>
                        </div>
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon blue-icon"><i class="fa-solid fa-robot"></i></div></div>
                            <h4>Automatizaciones</h4><p>Respuestas auto y tareas.</p>
                            <button type="button" class="btn-module" onclick="openTab(null, 'construccion')">+ Habilitar</button>
                        </div>
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon purple-icon"><i class="fa-solid fa-terminal"></i></div></div>
                            <h4>Comandos Custom</h4><p>Crea tus propios comandos.</p>
                            <button type="button" class="btn-module" onclick="openTab(null, 'construccion')">Crear</button>
                        </div>
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon green-icon"><i class="fa-solid fa-user-plus"></i></div></div>
                            <h4>Rastreador</h4><p>Control de invitaciones.</p>
                            <button type="button" class="btn-module" onclick="openTab(null, 'construccion')">+ Habilitar</button>
                        </div>
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon green-icon"><i class="fa-solid fa-ticket"></i></div></div>
                            <h4>Tickets</h4><p>Soporte privado.</p>
                            <button type="button" class="btn-module" onclick="openTab(null, 'construccion')">+ Habilitar</button>
                        </div>
                    </div>

                    <h3 class="section-title"><i class="fa-solid fa-gamepad"></i> Diversi칩n</h3>
                    <div class="modules-grid">
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon yellow-icon"><i class="fa-solid fa-icons"></i></div></div>
                            <h4>Emojis</h4><p>Gesti칩n de emojis del servidor.</p>
                            <button type="button" class="btn-module" onclick="openTab(null, 'emojis')">Gestionar</button>
                        </div>
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon cyan-icon"><i class="fa-solid fa-bell"></i></div></div>
                            <h4>Recordatorios</h4><p>Alarmas y avisos.</p>
                            <button type="button" class="btn-module" onclick="openTab(null, 'construccion')">+ Habilitar</button>
                        </div>
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon red-icon"><i class="fa-solid fa-cake-candles"></i></div></div>
                            <h4>Cumplea침os</h4><p>Felicitaciones autom치ticas.</p>
                            <button type="button" class="btn-module" onclick="openTab(null, 'construccion')">+ Habilitar</button>
                        </div>
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon purple-icon"><i class="fa-solid fa-gift"></i></div></div>
                            <h4>Sorteos</h4><p>Giveaways para la comunidad.</p>
                            <button type="button" class="btn-module" onclick="openTab(null, 'construccion')">Crear</button>
                        </div>
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon yellow-icon"><i class="fa-solid fa-trophy"></i></div><span class="premium-badge">TOP</span></div>
                            <h4>Niveles y XP</h4><p>Ranking de actividad.</p>
                            <button type="button" class="btn-module" onclick="openTab(null, 'construccion')">+ Habilitar</button>
                        </div>
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon purple-icon"><i class="fa-solid fa-music"></i></div></div>
                            <h4>M칰sica</h4><p>Reproductor 24/7 de alta calidad.</p>
                            <button type="button" class="btn-module" onclick="openTab(null, 'construccion')">+ Habilitar</button>
                        </div>
                    </div>

                    <h3 class="section-title"><i class="fa-solid fa-star"></i> Extras</h3>
                    <div class="modules-grid">
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon yellow-icon"><i class="fa-solid fa-coins"></i></div></div>
                            <h4>Econom칤a</h4><p>Moneda virtual y tienda.</p>
                            <button type="button" class="btn-module" onclick="openTab(null, 'construccion')">+ Habilitar</button>
                        </div>
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon blue-icon"><i class="fa-solid fa-chart-simple"></i></div></div>
                            <h4>Estad칤sticas</h4><p>Contadores de miembros.</p>
                            <button type="button" class="btn-module" onclick="openTab(null, 'construccion')">+ Habilitar</button>
                        </div>
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon cyan-icon"><i class="fa-solid fa-magnifying-glass"></i></div></div>
                            <h4>Buscador</h4><p>Google/YouTube en Discord.</p>
                            <button type="button" class="btn-module" onclick="openTab(null, 'construccion')">+ Habilitar</button>
                        </div>
                        <div class="module-card">
                            <div class="module-header"><div class="module-icon green-icon"><i class="fa-solid fa-circle-question"></i></div></div>
                            <h4>Ayuda</h4><p>Soporte y comandos de info.</p>
                            <button type="button" class="btn-module" onclick="openTab(null, 'construccion')">Ver</button>
                        </div>
                    </div>
                </div>

                <div id="bienvenida" class="tab-content" style="display: none;">
                    <div class="content-header"><h1>Sistema de Bienvenida</h1><p>Recibe a tus usuarios como se merecen.</p></div>
                    
                    <div class="settings-card">
                        
                        <div class="setting-row" style="align-items: center; justify-content: space-between;">
                            <div class="setting-info">
                                <label>Habilitar Bienvenida</label>
                                <span class="desc">Activa o desactiva este m칩dulo.</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" name="welcomeEnabled" class="change-detect" <%= config.welcomeEnabled ? 'checked' : '' %>>
                                <span class="slider round"></span>
                            </label>
                        </div>

                        <hr class="divider">

                        <div class="setting-row">
                            <div class="setting-info">
                                <label>Canal de Bienvenida</label>
                                <span class="desc">쮻칩nde enviar치 el bot el mensaje?</span>
                            </div>
                            <div class="setting-input">
                                <select name="welcomeChannel" class="form-input change-detect">
                                    <option value="" disabled <%= !config.welcomeChannel ? 'selected' : '' %>>Selecciona un canal...</option>
                                    <% if (typeof channels !== 'undefined' && channels.length > 0) { %>
                                        <% channels.forEach(ch => { %>
                                            <option value="<%= ch.id %>" <%= config.welcomeChannel === ch.id ? 'selected' : '' %>># <%= ch.name %></option>
                                        <% }) %>
                                    <% } else { %>
                                        <option value="" disabled>No hay canales disponibles</option>
                                    <% } %>
                                </select>
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <label>Mensaje de Texto</label>
                                <span class="desc">Variables: <code>{user}</code> <code>{server}</code></span>
                            </div>
                            <div class="setting-input">
                                <textarea name="welcomeMessage" rows="5" class="form-input change-detect"><%= config.welcomeMessage %></textarea>
                            </div>
                        </div>

                    </div>
                </div>

                <div id="ajustes" class="tab-content" style="display: none;">
                    <div class="content-header"><h1>Ajustes Generales</h1><p>Configuraci칩n b치sica.</p></div>
                    <div class="settings-card">
                        <div class="setting-row">
                            <div class="setting-info"><label>Prefijo</label><span class="desc">S칤mbolo para comandos.</span></div>
                            <div class="setting-input"><input type="text" name="prefix" value="<%= config.prefix %>" class="form-input change-detect"></div>
                        </div>
                    </div>
                </div>

                <div id="construccion" class="tab-content" style="display: none; text-align: center; padding-top: 50px;">
                    <i class="fa-solid fa-person-digging" style="font-size: 4rem; color: rgba(255,255,255,0.2); margin-bottom: 20px;"></i>
                    <h2>Pr칩ximamente</h2><p>M칩dulo en desarrollo.</p>
                </div>
                <div id="personalizador" class="tab-content" style="display: none; text-align: center; padding-top: 50px;"><h2>游꿛 Personalizador</h2></div>
                <div id="premium" class="tab-content" style="display: none; text-align: center; padding-top: 50px;"><h2>游눑 Premium</h2></div>
                <div id="emojis" class="tab-content" style="display: none; text-align: center; padding-top: 50px;"><h2>游 Emojis</h2></div>

                <div id="saveBar" class="floating-save-bar">
                    <span>춰Tienes cambios sin guardar!</span>
                    <button type="submit" class="btn-save">Guardar Cambios</button>
                </div>
            </form>
        </main>
    </div>

    <div id="successToast" class="success-toast"><i class="fa-solid fa-check-circle"></i> Guardado correctamente</div>

    <script>
        // 1. Nieve
        const snowContainer = document.querySelector('.snow-container');
        if(snowContainer) {
            for(let i=0; i<50; i++) {
                const div = document.createElement('div'); div.className = 'snow';
                div.style.left = Math.random() * 100 + '%'; div.style.animationDuration = (Math.random() * 5 + 5) + 's'; div.style.opacity = Math.random();
                snowContainer.appendChild(div);
            }
        }
        // 2. Tabs
        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(d => {d.style.display='none'; d.classList.remove('active-anim');});
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            const sel = document.getElementById(tabName);
            if(sel) { sel.style.display='block'; setTimeout(()=>sel.classList.add("active-anim"),10); }
            if(evt) evt.currentTarget.classList.add('active');
        }
        document.getElementById('sidebarToggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('collapsed'));
        
        // 3. Server Selector
        const serverMenu = document.getElementById('serverMenu');
        function toggleServerMenu() { serverMenu.classList.toggle('show'); }
        
        function selectServer(id) {
            // REDIRECCI칍N PARA CARGAR DATOS
            window.location.href = '/dashboard?guild=' + id;
        }

        window.onclick = e => { if(!e.target.closest('.server-dropdown-container')) serverMenu.classList.remove('show'); };
        
        // 4. Save
        const form=document.getElementById('configForm'), saveBar=document.getElementById('saveBar'), inputs=document.querySelectorAll('.change-detect');
        let initVals={}; 
        inputs.forEach(i => { 
            initVals[i.name] = i.type === 'checkbox' ? i.checked : i.value; 
            i.addEventListener('change', checkChanges);
            i.addEventListener('input', checkChanges);
        });
        
        function checkChanges(){
            let chg=false; 
            inputs.forEach(i => { 
                const val = i.type === 'checkbox' ? i.checked : i.value;
                if(val !== initVals[i.name]) chg=true; 
            });
            saveBar.classList.toggle('show', chg);
        }
        
        form.addEventListener('submit', e=>{
            e.preventDefault();
            fetch('/save-config', {method:'POST', body:new URLSearchParams(new FormData(form))}).then(r=>{
                if(r.ok){
                    saveBar.classList.remove('show'); 
                    inputs.forEach(i => initVals[i.name] = i.type === 'checkbox' ? i.checked : i.value);
                    const t=document.getElementById('successToast'); t.classList.add('active'); setTimeout(()=>t.classList.remove('active'),3000);
                }
            }).catch(()=>alert("Error"));
        });
    </script>
</body>
</html>