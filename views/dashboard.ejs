<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Habbus</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <% 
        let currentServer = { name: "Sin servidores", icon: "https://cdn.discordapp.com/embed/avatars/0.png", id: "" };
        if (typeof servers !== 'undefined' && servers.length > 0) {
            if (typeof selectedGuildId !== 'undefined' && selectedGuildId) {
                const found = servers.find(s => s.id === selectedGuildId);
                if (found) currentServer = { name: found.name, icon: found.icon ? `https://cdn.discordapp.com/icons/${found.id}/${found.icon}.png` : `https://cdn.discordapp.com/embed/avatars/0.png`, id: found.id };
            } 
            if (!currentServer.id && servers.length > 0) {
                const first = servers[0];
                currentServer = { name: first.name, icon: first.icon ? `https://cdn.discordapp.com/icons/${first.id}/${first.icon}.png` : `https://cdn.discordapp.com/embed/avatars/0.png`, id: first.id };
            }
        }
    %>

    <div class="snow-container"></div>

    <nav class="top-nav">
        <div class="nav-left">
            <button id="sidebarToggle" class="toggle-btn"><i class="fa-solid fa-bars"></i></button>
            <a href="/" class="brand"><img src="/images/logo_navidad.png" alt="Habbus"></a>
            <div class="status-console"><span class="status-dot"></span><span class="console-text">SYSTEM: <span style="color: #43b581;">ONLINE</span></span></div>
        </div>
        <div class="nav-right">
            <a href="/invite" target="_blank" class="nav-invite-btn"><i class="fa-solid fa-plus"></i> Invitar</a>
            <div class="server-dropdown-container">
                <div class="server-selector" onclick="toggleServerMenu()">
                    <img id="currentServerIcon" src="<%= currentServer.icon %>" class="server-icon-small">
                    <span id="currentServerName"><%= currentServer.name %></span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
                <div id="serverMenu" class="server-list-dropdown">
                    <% if (typeof servers !== 'undefined' && servers.length > 0) { %>
                        <% servers.forEach((guild) => { %>
                            <div class="server-option" onclick="selectServer('<%= guild.id %>')">
                                <img src="<%= guild.icon ? `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png` : `https://cdn.discordapp.com/embed/avatars/0.png` %>">
                                <span><%= guild.name %></span>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <div class="server-option"><span>No administras servidores</span></div>
                    <% } %>
                </div>
            </div>
            <a href="#" class="nav-premium-btn"><i class="fa-solid fa-crown"></i> Premium</a>
            <div class="user-dropdown">
                <div class="user-info-text"><span class="username"><%= user.username %></span><span class="user-role">Admin</span></div>
                <img src="https://cdn.discordapp.com/avatars/<%= user.id %>/<%= user.avatar %>.png" alt="Avatar">
                <a href="/logout" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i></a>
            </div>
        </div>
    </nav>

    <div class="layout-wrapper">
        
        <aside class="sidebar" id="sidebar">
            <div class="menu-section">
                <div class="menu-item" onclick="openTab(event, 'consola')" style="color: #43b581;"><i class="fa-solid fa-terminal"></i> Consola en Vivo</div>
                <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 10px 0;">
                
                <div class="menu-item active" onclick="openTab(event, 'panel')"><i class="fa-solid fa-border-all"></i> Panel de control</div>
                <div class="menu-item" onclick="openTab(event, 'personalizador')"><i class="fa-solid fa-wand-magic-sparkles"></i> Personalizador</div>
                <div class="menu-item" onclick="openTab(event, 'ajustes')"><i class="fa-solid fa-gear"></i> Ajustes</div>
                <div class="menu-item" onclick="openTab(event, 'premium')"><i class="fa-solid fa-crown" style="color: var(--gold);"></i> Premium</div>
                <div class="menu-item" onclick="openTab(event, 'emojis')"><i class="fa-solid fa-icons"></i> Emojis</div>
            </div>
            <div class="menu-section">
                <span class="menu-header">GESTIÃ“N DEL SERVIDOR</span>
                <div class="menu-item" onclick="openTab(event, 'bienvenida')"><i class="fa-solid fa-hand-spock"></i> Bienvenidas</div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-door-open"></i> Canal Bienvenida</div>
                <div class="menu-item" onclick="openTab(event, 'moderacion')"><i class="fa-solid fa-gavel"></i> ModeraciÃ³n</div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-medal"></i> Logros</div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-user-check"></i> VerificaciÃ³n</div>
                <div class="menu-item" onclick="openTab(event, 'registros')"><i class="fa-solid fa-file-lines"></i> Registros</div>
            </div>
            <div class="menu-section">
                <span class="menu-header">UTILIDADES</span>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-id-card"></i> Roles ReacciÃ³n</div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-pen-to-square"></i> Embeds</div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-rss"></i> Alertas Sociales</div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-robot"></i> Automatizaciones</div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-terminal"></i> Comandos</div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-user-plus"></i> Rastreador</div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-ticket"></i> Tickets</div>
            </div>
            <div class="menu-section">
                <span class="menu-header">DIVERSIÃ“N Y COMUNIDAD</span>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-bell"></i> Recordatorios</div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-cake-candles"></i> CumpleaÃ±os</div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-gift"></i> Sorteos</div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-trophy"></i> Niveles y XP</div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-music"></i> MÃºsica</div>
            </div>
            <div class="menu-section">
                <span class="menu-header">EXTRAS</span>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-coins"></i> EconomÃ­a</div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-chart-simple"></i> EstadÃ­sticas</div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-magnifying-glass"></i> Buscador</div>
                <div class="menu-item" onclick="openTab(event, 'construccion')"><i class="fa-solid fa-circle-question"></i> Ayuda</div>
            </div>
            <div class="menu-footer">
                <a href="/" class="menu-item back-item"><i class="fa-solid fa-arrow-left"></i> Volver al Inicio</a>
            </div>
        </aside>

        <main class="content-area">
            <form id="configForm" action="/save-config" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="guildId" id="guildIdInput" value="<%= currentServer.id %>">

                <div id="consola" class="tab-content" style="display: none;">
                    <div class="content-header"><h1>Consola del Sistema</h1><p>Logs en tiempo real del servidor.</p></div>
                    <div class="terminal-window">
                        <div class="terminal-header">
                            <div class="term-btn term-red"></div><div class="term-btn term-yellow"></div><div class="term-btn term-green"></div>
                            <span class="term-title">root@habbus-server:~</span>
                        </div>
                        <div class="terminal-body" id="terminalOutput">
                            <div class="log-entry">Cargando conexiÃ³n segura...</div>
                        </div>
                    </div>
                </div>

                <div id="panel" class="tab-content active" style="display: block; opacity: 1;">
                    <div class="content-header"><h1>Panel de Control</h1><p>Gestiona los mÃ³dulos de <strong><%= currentServer.name %></strong></p></div>
                    <div class="stats-grid">
                        <div class="stat-card"><i class="fa-solid fa-signal" style="color: #43b581;"></i><div><h3><%= stats.status %></h3><span>Estado</span></div></div>
                        <div class="stat-card"><i class="fa-solid fa-server" style="color: #5865F2;"></i><div><h3><%= stats.servers %></h3><span>Servidores</span></div></div>
                        <div class="stat-card"><i class="fa-solid fa-bolt" style="color: #ffc107;"></i><div><h3><%= stats.ping %>ms</h3><span>Latencia</span></div></div>
                    </div>
                    <hr class="divider">
                    <h3 class="section-title"><i class="fa-solid fa-server"></i> GestiÃ³n del Servidor</h3>
                    <div class="modules-grid">
                        <div class="module-card"><div class="module-header"><div class="module-icon blue-icon"><i class="fa-solid fa-hand-spock"></i></div></div><h4>Bienvenidas</h4><p>Configura mensajes de entrada.</p><button type="button" class="btn-module" onclick="openTab(null, 'bienvenida')">Configurar</button></div>
                        <div class="module-card"><div class="module-header"><div class="module-icon cyan-icon"><i class="fa-solid fa-door-open"></i></div></div><h4>Canal Bienvenida</h4><p>Define dÃ³nde saluda el bot.</p><button type="button" class="btn-module" onclick="openTab(null, 'construccion')">Configurar</button></div>
                        <div class="module-card"><div class="module-header"><div class="module-icon red-icon"><i class="fa-solid fa-gavel"></i></div></div><h4>ModeraciÃ³n</h4><p>Ban, kick, mute y automod.</p><button type="button" class="btn-module" onclick="openTab(null, 'moderacion')">Configurar</button></div>
                        <div class="module-card"><div class="module-header"><div class="module-icon yellow-icon"><i class="fa-solid fa-medal"></i></div></div><h4>Logros</h4><p>Medallas para usuarios.</p><button type="button" class="btn-module" onclick="openTab(null, 'construccion')">+ Habilitar</button></div>
                        <div class="module-card"><div class="module-header"><div class="module-icon green-icon"><i class="fa-solid fa-user-check"></i></div></div><h4>VerificaciÃ³n</h4><p>Sistema de captcha.</p><button type="button" class="btn-module" onclick="openTab(null, 'construccion')">+ Habilitar</button></div>
                        <div class="module-card"><div class="module-header"><div class="module-icon purple-icon"><i class="fa-solid fa-file-lines"></i></div></div><h4>Registros</h4><p>Logs de auditorÃ­a.</p><button type="button" class="btn-module" onclick="openTab(null, 'registros')">+ Habilitar</button></div>
                    </div>
                    <h3 class="section-title"><i class="fa-solid fa-toolbox"></i> Utilidades</h3>
                    <div class="modules-grid">
                        <div class="module-card"><div class="module-header"><div class="module-icon yellow-icon"><i class="fa-solid fa-id-card"></i></div></div><h4>Roles ReacciÃ³n</h4><p>Roles por clic en emoji.</p><button type="button" class="btn-module" onclick="openTab(null, 'construccion')">Configurar</button></div>
                        <div class="module-card"><div class="module-header"><div class="module-icon cyan-icon"><i class="fa-solid fa-pen-to-square"></i></div></div><h4>Embeds</h4><p>Mensajes visuales avanzados.</p><button type="button" class="btn-module" onclick="openTab(null, 'construccion')">Crear</button></div>
                    </div>
                </div>

                <div id="personalizador" class="tab-content" style="display: none;">
                    <div class="content-header"><h1>Personalizador</h1><p>Define la identidad y presencia del bot.</p></div>
                    <div class="settings-card">
                        <div class="setting-row" style="align-items: flex-start;">
                            <div class="setting-info" style="flex: 1;">
                                <div style="margin-bottom: 20px;"><label>Apodo en este Servidor</label><input type="text" name="botNickname" value="<%= config.botNickname || 'Habbus' %>" class="form-input change-detect" placeholder="Ej: Santa Claus"></div>
                                <div style="margin-bottom: 20px;"><label>Avatar del Servidor</label><span class="desc">Sube una imagen (PNG o JPG, mÃ¡x 8MB).</span>
                                    <div class="file-input-wrapper"><input type="file" id="botAvatarInput" name="botAvatarFile" accept="image/*" class="hidden-file-input change-detect"><label for="botAvatarInput" class="custom-file-btn"><i class="fa-solid fa-cloud-arrow-up"></i> <span id="fileNameDisplay">Seleccionar Imagen</span></label></div>
                                </div>
                                <div style="margin-bottom: 20px;"><label>Estado del Bot</label><select name="botStatus" id="statusSelect" class="form-input change-detect"><option value="online" <%= config.botStatus === 'online' ? 'selected' : '' %>>ðŸŸ¢ En LÃ­nea</option><option value="idle" <%= config.botStatus === 'idle' ? 'selected' : '' %>>ðŸŒ™ Ausente</option><option value="dnd" <%= config.botStatus === 'dnd' ? 'selected' : '' %>>â›” No Molestar</option><option value="invisible" <%= config.botStatus === 'invisible' ? 'selected' : '' %>>ðŸ‘» Invisible</option></select></div>
                                <div style="display: flex; gap: 10px;"><div style="flex: 1;"><label>Tipo</label><select name="activityType" id="activityTypeSelect" class="form-input change-detect"><option value="0" <%= config.activityType === 0 ? 'selected' : '' %>>Jugando a</option><option value="3" <%= config.activityType === 3 ? 'selected' : '' %>>Viendo</option><option value="2" <%= config.activityType === 2 ? 'selected' : '' %>>Escuchando</option><option value="5" <%= config.activityType === 5 ? 'selected' : '' %>>Compitiendo en</option></select></div><div style="flex: 2;"><label>Texto</label><input type="text" name="activityText" id="activityTextInput" value="<%= config.activityText || 'Navidad' %>" class="form-input change-detect"></div></div>
                            </div>
                            <div class="setting-input" style="flex: 0 0 320px; margin-left: 40px;">
                                <label style="margin-bottom: 10px; display: block;">Vista Previa</label>
                                <div class="discord-preview-card">
                                    <div class="discord-user">
                                        <div class="avatar-wrapper"><img src="<%= config.botAvatar || '/images/logo_navidad.png' %>" alt="Bot" class="bot-avatar-preview" id="previewAvatarImg"><div class="status-indicator" id="previewStatusDot"></div></div>
                                        <div style="display: flex; flex-direction: column;"><div style="display: flex; align-items: center; gap: 5px;"><span class="bot-name-preview"><%= config.botNickname || 'Habbus' %></span><span class="bot-tag">BOT</span></div><span class="activity-preview" id="previewActivity" style="font-size: 0.75rem; color: #b9bbbe;">Jugando a <strong>Navidad</strong></span></div>
                                    </div>
                                    <div class="discord-embed" id="embedPreview" style="border-left-color: <%= config.embedColor || '#ff0f0f' %>; margin-top: 10px;"><div class="embed-title">Mensaje de Ejemplo</div><div class="embed-desc">Â¡Hola! AsÃ­ se ve mi perfil y mis colores.</div></div>
                                </div>
                                <div style="margin-top: 20px;"><label>Color del Tema</label><div style="margin-top: 5px; display: flex; align-items: center; gap: 10px;"><input type="color" id="colorPicker" name="embedColor" value="<%= config.embedColor || '#ff0f0f' %>" class="change-detect" style="height: 40px; width: 100%; cursor: pointer; border: none; background: none;"></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="ajustes" class="tab-content" style="display: none;">
                    <div class="content-header"><h1>Ajustes Generales</h1><p>ConfiguraciÃ³n esencial del nÃºcleo del bot.</p></div>
                    <div class="settings-card">
                        <div class="setting-row"><div class="setting-info"><label>Prefijo</label></div><div class="setting-input"><input type="text" name="prefix" value="<%= config.prefix %>" class="form-input change-detect" style="width: 100px;"></div></div>
                        <div class="setting-row"><div class="setting-info"><label>Idioma</label></div><div class="setting-input"><select name="language" class="form-input change-detect"><option value="es" <%= config.language === 'es' ? 'selected' : '' %>>ðŸ‡ªðŸ‡¸ EspaÃ±ol</option><option value="en" <%= config.language === 'en' ? 'selected' : '' %>>ðŸ‡ºðŸ‡¸ English</option></select></div></div>
                        <div class="setting-row"><div class="setting-info"><label>Zona Horaria</label></div><div class="setting-input"><select name="timezone" class="form-input change-detect"><option value="America/Bogota" <%= config.timezone === 'America/Bogota' ? 'selected' : '' %>>ðŸ‡¨ðŸ‡´ Colombia</option><option value="America/Mexico_City" <%= config.timezone === 'America/Mexico_City' ? 'selected' : '' %>>ðŸ‡²ðŸ‡½ MÃ©xico</option><option value="Europe/Madrid" <%= config.timezone === 'Europe/Madrid' ? 'selected' : '' %>>ðŸ‡ªðŸ‡¸ EspaÃ±a</option><option value="America/New_York" <%= config.timezone === 'America/New_York' ? 'selected' : '' %>>ðŸ‡ºðŸ‡¸ USA Este</option></select></div></div>
                        <div class="setting-row" style="align-items: center; justify-content: space-between;"><div class="setting-info"><label>Respuestas Silenciosas</label></div><label class="switch"><input type="checkbox" name="ephemeralReplies" class="change-detect" <%= config.ephemeralReplies ? 'checked' : '' %>><span class="slider round"></span></label></div>
                        <hr class="divider">
                        <div class="setting-row"><div class="setting-info"><label>Canales Ignorados</label><span class="desc">No responder aquÃ­.</span></div><div class="setting-input"><div class="multiselect-container" id="dd-ignored"><div class="select-box" onclick="toggleMultiSelect('dd-ignored')"><span class="selected-text">Seleccionar...</span><i class="fa-solid fa-chevron-down"></i></div><div class="options-container"><% if(typeof channels !== 'undefined' && channels.length > 0){ channels.forEach(c => { let isChecked = config.ignoredChannels && (Array.isArray(config.ignoredChannels) ? config.ignoredChannels.includes(c.id) : config.ignoredChannels == c.id); %><label class="option-item"><input type="checkbox" name="ignoredChannels" value="<%= c.id %>" <%= isChecked ? 'checked' : '' %> onchange="updateSelectText('dd-ignored')"><span># <%= c.name %></span></label><% }) } else { %><div style="color: #888; padding: 10px;">Sin canales.</div><% } %></div></div></div></div>
                        <hr class="divider">
                        <h3>JerarquÃ­a y Permisos</h3>
                        <p style="margin-bottom: 25px; color: #b9bbbe; font-size: 0.9rem; line-height: 1.5; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border-left: 3px solid var(--accent);">Define quÃ© roles tienen autoridad sobre el bot.<br>â€¢ <strong>Administrador:</strong> Acceso total al panel y configuraciÃ³n.<br>â€¢ <strong>Moderador:</strong> Puede usar comandos de ban, kick y mute.<br>â€¢ <strong>Silenciado:</strong> Rol que se asignarÃ¡ a los usuarios castigados.</p>
                        <div class="setting-row"><div class="setting-info"><label>Roles Admin</label></div><div class="setting-input"><div class="multiselect-container" id="dd-admin"><div class="select-box" onclick="toggleMultiSelect('dd-admin')"><span class="selected-text">Seleccionar...</span><i class="fa-solid fa-chevron-down"></i></div><div class="options-container"><% if(typeof roles !== 'undefined' && roles.length > 0){ roles.forEach(r => { let isChecked = config.adminRole && (Array.isArray(config.adminRole) ? config.adminRole.includes(r.id) : config.adminRole == r.id); let textColor = r.color === '#000000' ? '#ddd' : r.color; %><label class="option-item"><input type="checkbox" name="adminRole" value="<%= r.id %>" <%= isChecked ? 'checked' : '' %> onchange="updateSelectText('dd-admin')"><span class="role-dot-small" style="background-color: <%= r.color %>;"></span><span style="color: <%= textColor %>"><%= r.name %></span></label><% }) } else { %><div style="color: #888; padding: 10px;">Sin roles.</div><% } %></div></div></div></div>
                        <div class="setting-row"><div class="setting-info"><label>Roles Moderador</label></div><div class="setting-input"><div class="multiselect-container" id="dd-mod"><div class="select-box" onclick="toggleMultiSelect('dd-mod')"><span class="selected-text">Seleccionar...</span><i class="fa-solid fa-chevron-down"></i></div><div class="options-container"><% if(typeof roles !== 'undefined' && roles.length > 0){ roles.forEach(r => { let isChecked = config.modRole && (Array.isArray(config.modRole) ? config.modRole.includes(r.id) : config.modRole == r.id); let textColor = r.color === '#000000' ? '#ddd' : r.color; %><label class="option-item"><input type="checkbox" name="modRole" value="<%= r.id %>" <%= isChecked ? 'checked' : '' %> onchange="updateSelectText('dd-mod')"><span class="role-dot-small" style="background-color: <%= r.color %>;"></span><span style="color: <%= textColor %>"><%= r.name %></span></label><% }) } %></div></div></div></div>
                        <div class="setting-row"><div class="setting-info"><label>Rol Silenciado</label></div><div class="setting-input"><select name="muteRole" class="form-input change-detect"><option value="">-- Ãšnico --</option><% if(typeof roles !== 'undefined' && roles.length > 0){ roles.forEach(r=>{ %><option value="<%= r.id %>" <%= config.muteRole===r.id?'selected':'' %> style="color:<%= r.color %>">@<%= r.name %></option><% }) } %></select></div></div>
                    </div>
                </div>

                <div id="bienvenida" class="tab-content" style="display: none;">
                    <div class="content-header"><h1>Sistema de Bienvenida</h1></div>
                    <div class="settings-card"><div class="setting-row"><label>Habilitar</label><input type="checkbox" name="welcomeEnabled" <%= config.welcomeEnabled?'checked':'' %>></div><div class="setting-row"><label>Canal</label><select name="welcomeChannel"><option value="" disabled>Selecciona...</option><% if (typeof channels !== 'undefined' && channels.length > 0) { %><% channels.forEach(ch => { %><option value="<%= ch.id %>" <%= config.welcomeChannel === ch.id ? 'selected' : '' %>># <%= ch.name %></option><% }) %><% } %></select></div><div class="setting-row"><label>Mensaje</label><textarea name="welcomeMessage" rows="5" class="form-input change-detect"><%= config.welcomeMessage %></textarea></div></div>
                </div>

                <div id="moderacion" class="tab-content" style="display: none;">
                    <div class="content-header"><h1>ModeraciÃ³n</h1></div>
                    <div class="settings-card"><div class="setting-row"><label>Anti-Malas Palabras</label><input type="checkbox" name="automodBadWords" <%= config.automodBadWords?'checked':'' %>></div><div class="setting-row"><label>Anti-Links</label><input type="checkbox" name="automodLinks" <%= config.automodLinks?'checked':'' %>></div></div>
                </div>

                <div id="registros" class="tab-content" style="display: none;">
                    <div class="content-header"><h1>Registros</h1></div>
                    <div class="settings-card"><div class="setting-row"><label>Canal Logs</label><select name="logChannel"><option value="" disabled>Selecciona...</option><% if(typeof channels!=='undefined'){ channels.forEach(c=>{ %><option value="<%= c.id %>" <%= config.logChannel===c.id?'selected':'' %>># <%= c.name %></option><% }) } %></select></div><div class="setting-row"><label>Mensajes Borrados</label><input type="checkbox" name="logMessages" <%= config.logMessages?'checked':'' %>></div><div class="setting-row"><label>Entradas/Salidas</label><input type="checkbox" name="logMembers" <%= config.logMembers?'checked':'' %>></div></div>
                </div>

                <div id="construccion" class="tab-content" style="display: none; text-align: center; padding-top: 50px;"><i class="fa-solid fa-person-digging" style="font-size: 4rem; color: rgba(255,255,255,0.2); margin-bottom: 20px;"></i><h2>PrÃ³ximamente</h2></div>
                <div id="premium" class="tab-content" style="display: none; text-align: center; padding-top: 50px;"><h2>ðŸ’Ž Premium</h2></div>
                <div id="emojis" class="tab-content" style="display: none; text-align: center; padding-top: 50px;"><h2>ðŸ˜€ Emojis</h2></div>

                <div id="saveBar" class="floating-save-bar"><span>Â¡Tienes cambios sin guardar!</span><button type="submit" class="btn-save">Guardar Cambios</button></div>
            </form>
        </main>
    </div>

    <div id="successToast" class="success-toast"><i class="fa-solid fa-check-circle"></i> Guardado</div>

    <script>
        let logsInterval = null;

        function openTab(evt,name){
            document.querySelectorAll('.tab-content').forEach(d=>{d.style.display='none';d.style.opacity='0';});
            const s=document.getElementById(name);s.style.display='block';setTimeout(()=>s.style.opacity='1',10);
            if(evt) { document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active')); evt.currentTarget.classList.add('active'); }
            
            if(name === 'consola') {
                fetchLogs();
                if(!logsInterval) logsInterval = setInterval(fetchLogs, 2000);
            } else {
                if(logsInterval) { clearInterval(logsInterval); logsInterval = null; }
            }
        }

        function fetchLogs() {
            fetch('/api/logs').then(r => r.json()).then(data => {
                const term = document.getElementById('terminalOutput');
                term.innerHTML = data.map(l => `<div class="log-entry"><span class="log-time">[${l.time}]</span><span class="${l.type==='error'?'log-error':'log-info'}">${l.msg}</span></div>`).join('');
                term.scrollTop = term.scrollHeight;
            }).catch(console.error);
        }

        function selectServer(id){window.location.href='/dashboard?guild='+id;}
        function toggleServerMenu(){document.getElementById('serverMenu').classList.toggle('show');}
        
        // --- VISIBILIDAD INICIAL & DROPDOWNS ---
        window.onload = function() { 
            const p = document.getElementById('panel'); if(p) { p.style.display='block'; setTimeout(()=>p.style.opacity='1', 10); } 
            updateSelectText('dd-ignored'); updateSelectText('dd-admin'); updateSelectText('dd-mod');
        };

        // --- LÃ“GICA DROPDOWNS MULTI ---
        function toggleMultiSelect(id) {
            const container = document.getElementById(id);
            const box = container.querySelector('.select-box');
            const opts = container.querySelector('.options-container');
            document.querySelectorAll('.options-container').forEach(el => { if(el!==opts) el.classList.remove('show'); });
            opts.classList.toggle('show'); box.classList.toggle('active');
        }
        function updateSelectText(id) {
            const container = document.getElementById(id); if(!container) return;
            const checked = container.querySelectorAll('input[type="checkbox"]:checked');
            const textSpan = container.querySelector('.selected-text');
            if (checked.length === 0) { textSpan.textContent = "Seleccionar..."; textSpan.style.color = "#888"; } 
            else { textSpan.textContent = `${checked.length} seleccionado(s)`; textSpan.style.color = "#fff"; }
        }
        window.onclick = function(event) {
            if (!event.target.closest('.multiselect-container')) {
                document.querySelectorAll('.options-container').forEach(el => el.classList.remove('show'));
                document.querySelectorAll('.select-box').forEach(el => el.classList.remove('active'));
            }
            if(!event.target.closest('.server-dropdown-container')) document.getElementById('serverMenu').classList.remove('show');
        }

        const form=document.getElementById('configForm'), saveBar=document.getElementById('saveBar');
        form.addEventListener('change',()=>saveBar.classList.add('show'));
        form.addEventListener('input',()=>saveBar.classList.add('show'));

        // Personalizador
        const colorPicker = document.getElementById('colorPicker'), embedPreview = document.getElementById('embedPreview'), botNicknameInput = document.querySelector('input[name="botNickname"]'), botNamePreview = document.querySelector('.bot-name-preview'), botAvatarInput = document.getElementById('botAvatarInput'), previewAvatarImg = document.getElementById('previewAvatarImg');
        if(colorPicker) colorPicker.addEventListener('input', (e) => embedPreview.style.borderLeftColor = e.target.value);
        if(botNicknameInput) botNicknameInput.addEventListener('input', (e) => botNamePreview.textContent = e.target.value || "Habbus");
        if(botAvatarInput) botAvatarInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { document.getElementById('fileNameDisplay').textContent = file.name; const reader = new FileReader(); reader.onload = function(e) { previewAvatarImg.src = e.target.result; }; reader.readAsDataURL(file); } });

        form.addEventListener('submit', e => {
            e.preventDefault(); const fd=new FormData(form);
            fetch('/save-config',{method:'POST',body:fd}).then(r=>{if(r.ok){saveBar.classList.remove('show');document.getElementById('successToast').classList.add('active');setTimeout(()=>document.getElementById('successToast').classList.remove('active'),2000)}});
        });
    </script>
</body>
</html>